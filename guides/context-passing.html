<!doctype html>
<html lang="en">

<head>
    <title>SmallRye Mutiny</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="SmallRye Mutiny!">

    <link rel="canonical" href="/guides/context-passing.html">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.1/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/components/icon.min.css" integrity="sha512-8Tb+T7SKUFQWOPIQCaLDWWe1K/SY8hvHl7brOH8Nz5z1VT8fnf8B+9neoUzmFY3OzkWMMs3OjrwZALgB1oXFBg==" crossorigin="anonymous" />
    <link rel="shortcut icon" type="image/png" href="/smallrye-mutiny/assets/images/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="/smallrye-mutiny/assets/css/main.css" />
    <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/font-awesome-line-awesome/css/all.min.css">
    <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
</head>

<body>
    <div class="container-fluid global-container">
        





<header class="header masthead mb-auto">
    <div class="container">
        <nav class="navbar navbar-dark navbar-expand-lg">
            <a class="navbar-brand brand mutiny" href="/smallrye-mutiny/index.html"><strong>Mutiny!</strong></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#toggler"
                    aria-controls="toggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="toggler">
                <ul class="navbar-nav ml-auto mr-0 mt-2 mt-lg-0">
                    <li class="nav-item"><a class="nav-link " href="/smallrye-mutiny/index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link " href="/smallrye-mutiny/pages/philosophy">Philosophy</a></li>
                    <li class="nav-item"><a class="nav-link " href="/smallrye-mutiny/getting-started/download">Getting started</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/smallrye-mutiny/guides">Guides</a></li>
                    <li class="nav-item"><a href="https://github.com/smallrye/smallrye-mutiny" target="_blank" title="Github"><i
                            class="lab la-github la-2x"></i></a></li>
                    <li class="nav-item"><a href="https://github.com/smallrye/smallrye-mutiny/discussions" target="_blank" title="Discussions on GitHub"><i
                            class="las la-comments la-2x"></i></a></li>
                    <li class="nav-item"><a href="https://stackoverflow.com/questions/tagged/mutiny" target="_blank"
                                            title="Stack Overflow"><i
                            class="lab la-stack-overflow la-2x"></i></a></li>
                </ul>
            </div>
        </nav>
    </div>
</header>
        <main>
            <div class="content">
                

<section class="hero gs">
    <div class="hero-main container">
        <div class="row">
            <div class="hero-left col-12">
                <div class="hero-slogan">
                    <h1 class="hero-name">Context passing</h1>
                </div>
                <div class="hero-desc">
                    Learn how to pass an implicit context between operators
                </div>
                <!-- TODO Labels -->
            </div>
        </div>
    </div>
</section>

<div class="container page-content">
    <div class="row">
        <div class="col-md-9 content">
            <div class="sect1">
<h2 id="context-passing"><a class="anchor" href="#context-passing"></a>Context passing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mutiny reactive pipelines let data flow from publishers to subscribers.</p>
</div>
<div class="paragraph">
<p>In the vast majority of cases a publisher shall have <em>all</em> required data, and operators shall perform processing based on item values.
For instance a network request shall be made with all request data known in advance, and response processing shall only depend on the response payload.</p>
</div>
<div class="paragraph">
<p>That being said there are cases were this is not sufficient, and some data has to be carried along with items.
For instance one intermediary operator in a pipeline may have to make another networked request from which we need to extract some correlation identifier which will be used by another operator down the pipeline.
In such cases one will be tempted to forward tuples consisting of some item value plus some "extra" data.</p>
</div>
<div class="paragraph">
<p>For such cases Mutiny offers a <em>subscriber-provided context</em>, so all operators involved in a subscription can share some form of <em>implicit data</em>.</p>
</div>
<div class="sect2">
<h3 id="whats-in-a-context"><a class="anchor" href="#whats-in-a-context"></a>What&#8217;s in a context?</h3>
<div class="paragraph">
<p>A context is a simple key / value, in-memory storage.
Data can be queried, added and deleted from a context, as shown in the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Create a context using key / value pairs
Context context = Context.of(
        "X-CUSTOMER-ID", "1234",
        "X-SPAN-ID", "foo-bar-baz"
);

// Get an entry
System.out.println(
        context.&lt;String&gt;get("X-SPAN-ID"));

// Get an entry, use a supplier for a default value if the key is not present
System.out.println(
        context.getOrElse("X-SPAN-ID", () -&gt; "&lt;no id&gt;"));

// Add an entry
context.put("foo", "bar");

// Remove an entry
context.delete("foo");</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Context</code> objects are thread-safe, and can be created from sequences of key / value pairs (as shown above), from a Java <code>Map</code>, or they can be created empty.</p>
</div>
<div class="paragraph">
<p>Note that an empty-created context defers its internal storage allocation until the first call to <code>put</code>.
You can see <code>Context</code> as a glorified <code>ConcurrentHashMap</code> delegate, although this is an implementation detail and Mutiny might explore various internal storage strategies in the future.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Contexts shall be primarily used to share transient data used for networked I/O processing such as correlation identifiers, tokens, etc.
They should not be used as general-purpose data structures that are frequently updated and that hold large amounts of data.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="how-to-access-a-context"><a class="anchor" href="#how-to-access-a-context"></a>How to access a context?</h3>
<div class="paragraph">
<p>Given a <code>Uni</code> or a <code>Multi</code>, a context can be accessed using the <code>withContext</code> operator, as in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = Context.of("X-CUSTOMER-ID", customerId);

pipeline.withContext((multi, ctx) -&gt; multi.onItem().transformToUniAndMerge(item -&gt; makeRequest(item, ctx.get("X-CUSTOMER-ID"))))
        .subscribe().with(context, item -&gt; handleResponse(item), err -&gt; handleFailure(err));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This operator builds a sub-pipeline using 2 parameters: the current <code>Uni</code> or <code>Multi</code> and the context.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The function passed to <code>withContext</code> is called at subscription time.
This means that the context has not had a chance to be updated by upstream operators yet, so be careful with what you do in the body of that function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is another way to access the context by using the <code>attachContext</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = Context.of("X-CUSTOMER-ID", customerId);

pipeline.attachContext()
        .onItem().transformToUniAndMerge(item -&gt; makeRequest(item.get(), item.context().get("X-CUSTOMER-ID")))
        .subscribe().with(context, item -&gt; handleResponse(item), err -&gt; handleFailure(err));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method materializes the context in the regular pipeline items using the wrapper <code>ItemWithContext</code> class.
The <code>get</code> method provides the item while the <code>context</code> method provides the context.</p>
</div>
</div>
<div class="sect2">
<h3 id="how-to-access-a-context-at-the-pipeline-source"><a class="anchor" href="#how-to-access-a-context-at-the-pipeline-source"></a>How to access a context at the pipeline source?</h3>
<div class="paragraph">
<p>The <code>Uni</code> and <code>Multi</code> <em>builder</em> methods like <code>Multi.createFrom()</code> provide publishers, not operators, so they don&#8217;t have the <code>withContext</code> method.</p>
</div>
<div class="paragraph">
<p>The first option is to use the <code>Uni.createFrom().context(&#8230;&#8203;)</code> or <code>Multi.createFrom().context(&#8230;&#8203;)</code> general purpose method to materialize the context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni.createFrom().context(ctx -&gt; makeRequest("db1", ctx.get("X-SPAN-ID")))
        .subscribe().with(context, item -&gt; handleResponse(item), err -&gt; handleFailure(err));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>context</code> method takes a function that accepts a <code>Context</code> and returns a pipeline.
This is very similar to the <code>deferred</code> builder.</p>
</div>
<div class="paragraph">
<p>If you use an <code>emitter</code> builder then for both <code>Uni</code> and <code>Multi</code> cases the emitter object offers a <code>context</code> method to access the context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Multi.createFrom().emitter(emitter -&gt; {
    String customerId = emitter.context().get("X-SPAN-ID");
    for (int i = 0; i &lt; 10; i++) {
        emitter.emit("@" + i + " [" + customerId + "]");
    }
    emitter.complete();
});</code></pre>
</div>
</div>
</div>
</div>
</div>
        </div>
        <div class="col-md-3 col-md-offset-1 toc-container d-sm-none d-md-block">
            <nav class="page-toc toc nav sticky-top" id="toc">
                
                <h4>Table of Content</h4>
                <ul class="sectlevel1">
<li><a href="#context-passing">Context passing</a>
<ul class="sectlevel2">
<li><a href="#whats-in-a-context">What&#8217;s in a context?</a></li>
<li><a href="#how-to-access-a-context">How to access a context?</a></li>
<li><a href="#how-to-access-a-context-at-the-pipeline-source">How to access a context at the pipeline source?</a></li>
</ul>
</li>
</ul>
                

                
            </nav>
        </div>
    </div>
</div>


            </div>
        </main>
        <footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-9 sep-right">
                <p>
                    SmallRye Mutiny is an open source project. All the code from this project is available under the <a href="https://raw.githubusercontent.com/smallrye/smallrye-mutiny/main/LICENSE">Apache Software License 2.0</a>.
                </p>
                <p>
                    This website was built with <a href="https://jekyllrb.com/">Jekyll</a>, is hosted on Github Pages and is completely open source.
                    You can <a href="https://github.com/smallrye/smallrye-mutiny">fork it</a> and propose enhancements through pull-requests.
                </p>
                <p>
                    Something's wrong? Open an <a href="https://github.com/smallrye/smallrye-mutiny/issues">issue</a>.
                </p>
            </div>
            <div class="col-lg-3">
                <p>
                    Sponsored by
                    <span class="redhat-logo">
                        <a href="https://www.redhat.com/" target="_blank"><img src="/smallrye-mutiny/assets/images/redhat_reversed.svg"></a>
                    </span>
                </p>
                <p>
                    <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
                    |
                    <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
                </p>
                <p>
                     Site last generated: Mar 10, 2022
                </p>
            </div>
        </div>
    </div>
    <!-- Javascript-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.3.1/highlight.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/gumshoe@4/dist/gumshoe.polyfills.min.js"></script>
    <script src="/smallrye-mutiny/assets/js/hl.js" type="text/javascript"></script>
    <script src="/smallrye-mutiny/assets/js/scrollspy.js" type="text/javascript"></script>

    <script>
        $(document).ready(function(){
            $("#search").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $(".guide").filter(function() {
                    $(this).toggle($(this).attr("data-search").toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPQ70JF1EY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FPQ70JF1EY');
    </script>
</footer>
    </div>
</body>

</html>